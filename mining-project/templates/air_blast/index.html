{% extends "base.html" %}

{% block content %}

    <!-- PAGE TITLE -->
    <div class="px-6 py-4">
        <div class="flex items-center gap-3">
            <i class="fa-solid fa-wind text-2xl text-gray-900"></i>
            <h1 class="text-2xl font-bold text-gray-900">
                Air Blast Modelling
            </h1>
        </div>
    </div>

    <!-- MAIN CONTENT AREA -->
    <div class="flex gap-6 p-6 w-full items-stretch">

        <!-- LEFT INPUT PANEL -->
        <div class="bg-base-100 border border-base-300 shadow-sm rounded-xl p-6
                    flex-none w-[360px] flex flex-col">

            <h2 class="text-lg font-bold mb-6">Model Inputs</h2>

            <!-- FORM -->
            <form method="POST" action="" class="flex-1 flex flex-col">
                {% csrf_token %}

                <!-- Distance (D) -->
                <div class="mb-5">
                    <label class="label pb-1">
                        <span class="label-text font-semibold">Distance from Blast (D)</span>
                    </label>
                    <input type="number" name="distance" required step="any" min="0"
                           class="input input-bordered w-full"
                           value="{{ distance|default:'' }}">
                </div>

                <!-- Charge Weight (W) -->
                <div class="mb-5">
                    <label class="label pb-1">
                        <span class="label-text font-semibold">Charge Weight (W)</span>
                    </label>
                    <input type="number" name="weight" required step="any" min="0"
                           class="input input-bordered w-full"
                           value="{{ weight|default:'' }}">
                </div>

                <!-- Model Select -->
                <div class="mb-4">
                    <label class="label pb-1">
                        <span class="label-text font-semibold">Select Model</span>
                    </label>

                    <select name="model"
                            class="select select-bordered w-full"
                            hx-get="{% url 'air_blast_load_model_form' %}"
                            hx-trigger="change"
                            hx-target="#model-form-inner"
                            required>
                        <option value="">-- Choose Model --</option>

                        {% for key, meta in model_registry.items %}
                            <option value="{{ key }}"
                                    {% if selected_model == key %}selected{% endif %}>
                                {{ meta.label }}
                            </option>
                        {% endfor %}
                    </select>
                </div>

                <!-- MODEL-SPECIFIC INPUTS (fixed height, scrollable inner content) -->
                <div id="model-form-container"
                     class="mt-4 pt-4 border-t border-gray-300 h-64">
                    <div id="model-form-inner"
                         class="h-full overflow-y-auto pr-1">
                        {% if model_form %}
                            {% include "air_blast/partials/model_form.html" with form=model_form%}
                        {% else %}
                            <p class="text-gray-400 text-sm">
                                Select a model to enter parameters.
                            </p>
                        {% endif %}
                    </div>
                </div>

                <!-- Spacer so button tucks nicely under the scroll area -->
                <div class="mt-4"></div>

                <!-- Submit -->
                <button class="btn w-full bg-gray-900 text-white hover:bg-gray-800">
                    Generate Graph
                </button>

            </form>

        </div>

        <!-- RIGHT GRAPH PANEL -->
        <div class="relative bg-base-100 border border-base-300 shadow-sm rounded-xl p-6
                    flex-1 flex flex-col">

            <!-- TOP RIGHT MENU -->
            <div class="absolute top-4 right-4 z-50">
                <div class="dropdown dropdown-end relative z-50">
                    <label tabindex="0" class="btn btn-ghost btn-xs text-gray-600 z-50">
                        <i class="fa-solid fa-ellipsis-vertical text-xl"></i>
                    </label>

                    <ul tabindex="0"
                        class="dropdown-content menu p-2 shadow bg-base-100 rounded-box w-56 z-[9999]">
                        <li>
                            <a href="{% url 'air_blast_export_excel' %}" class="flex items-center gap-2">
                                <i class="fa-solid fa-file-export"></i>
                                Export Data to Excel
                            </a>
                        </li>
                    </ul>
                </div>
            </div>

            <!-- GRAPH AREA -->
            <div class="bg-white p-6 flex-1 flex flex-col">
                <div id="plot-container" class="w-full h-full relative">
                    {% if options_json %}
                        <div id="air-blast-chart" class="h-full w-full"></div>
                    {% else %}
                        <div class="absolute inset-0 flex items-center justify-center">
                            <p class="text-gray-400">Graph will appear here...</p>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>

    </div>

{% endblock %}

{% block scripts %}
    {{ block.super }}

    {% if options_json %}
        <script>
            document.addEventListener("DOMContentLoaded", function () {
                const options = {{ options_json|safe }};
                window.renderEChart("air-blast-chart", options);
            });
        </script>
    {% endif %}
{% endblock %}
