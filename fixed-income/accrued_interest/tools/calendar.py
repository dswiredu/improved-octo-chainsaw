import calendar
import datetime

import numpy


def is_monthend(date):
    return date.day == calendar.monthrange(date.year, date.month)[1]


def in_range(dates, start, end):
    return dates[
        numpy.searchsorted(
            dates, numpy.datetime64(start)
        ) : numpy.searchsorted(dates, numpy.datetime64(end))
    ]


def get_nth_dow(start, end, n, dow):
    new_end = numpy.datetime64(end).astype("datetime64[M]") + 1
    return in_range(
        numpy.busday_offset(
            numpy.arange(start, new_end, dtype="datetime64[M]"),
            n - 1,
            roll="forward",
            weekmask=dow,
        ),
        start,
        end,
    )


def get_nth_day(start, end, n):
    dates = []
    start = datetime.datetime.strptime(start, "%Y-%m-%d")
    end = datetime.datetime.strptime(end, "%Y-%m-%d")
    for year in range(start.year, end.year + 1):
        for month in range(1, 13):
            try:
                date = datetime.datetime(year, month, n)
                if start <= date <= end:
                    dates.append(date)
            except ValueError:
                pass
    return numpy.array(dates, dtype="datetime64[D]")


def get_nth_busday(start, end, n):
    new_end = numpy.datetime64(end).astype("datetime64[M]") + 1
    return in_range(
        numpy.busday_offset(
            numpy.arange(start, new_end, dtype="datetime64[M]"),
            n - 1,
            roll="forward",
            holidays=US_FED_HOLIDAYS,
        ),
        start,
        end,
    )


def ensure_busday(dates, direction="forward"):
    return numpy.busday_offset(
        dates, 0, roll=direction, holidays=US_FED_HOLIDAYS
    )


# generated from pandas.tseries.holiday.USFederalHolidayCalendar().holidays
US_FED_HOLIDAYS = [
    "2010-01-01",
    "2010-01-18",
    "2010-02-15",
    "2010-05-31",
    "2010-07-05",
    "2010-09-06",
    "2010-10-11",
    "2010-11-11",
    "2010-11-25",
    "2010-12-24",
    "2010-12-31",
    "2011-01-17",
    "2011-02-21",
    "2011-05-30",
    "2011-07-04",
    "2011-09-05",
    "2011-10-10",
    "2011-11-11",
    "2011-11-24",
    "2011-12-26",
    "2012-01-02",
    "2012-01-16",
    "2012-02-20",
    "2012-05-28",
    "2012-07-04",
    "2012-09-03",
    "2012-10-08",
    "2012-11-12",
    "2012-11-22",
    "2012-12-25",
    "2013-01-01",
    "2013-01-21",
    "2013-02-18",
    "2013-05-27",
    "2013-07-04",
    "2013-09-02",
    "2013-10-14",
    "2013-11-11",
    "2013-11-28",
    "2013-12-25",
    "2014-01-01",
    "2014-01-20",
    "2014-02-17",
    "2014-05-26",
    "2014-07-04",
    "2014-09-01",
    "2014-10-13",
    "2014-11-11",
    "2014-11-27",
    "2014-12-25",
    "2015-01-01",
    "2015-01-19",
    "2015-02-16",
    "2015-05-25",
    "2015-07-03",
    "2015-09-07",
    "2015-10-12",
    "2015-11-11",
    "2015-11-26",
    "2015-12-25",
    "2016-01-01",
    "2016-01-18",
    "2016-02-15",
    "2016-05-30",
    "2016-07-04",
    "2016-09-05",
    "2016-10-10",
    "2016-11-11",
    "2016-11-24",
    "2016-12-26",
    "2017-01-02",
    "2017-01-16",
    "2017-02-20",
    "2017-05-29",
    "2017-07-04",
    "2017-09-04",
    "2017-10-09",
    "2017-11-10",
    "2017-11-23",
    "2017-12-25",
    "2018-01-01",
    "2018-01-15",
    "2018-02-19",
    "2018-05-28",
    "2018-07-04",
    "2018-09-03",
    "2018-10-08",
    "2018-11-12",
    "2018-11-22",
    "2018-12-25",
    "2019-01-01",
    "2019-01-21",
    "2019-02-18",
    "2019-05-27",
    "2019-07-04",
    "2019-09-02",
    "2019-10-14",
    "2019-11-11",
    "2019-11-28",
    "2019-12-25",
    "2020-01-01",
    "2020-01-20",
    "2020-02-17",
    "2020-05-25",
    "2020-07-03",
    "2020-09-07",
    "2020-10-12",
    "2020-11-11",
    "2020-11-26",
    "2020-12-25",
    "2021-01-01",
    "2021-01-18",
    "2021-02-15",
    "2021-05-31",
    "2021-07-05",
    "2021-09-06",
    "2021-10-11",
    "2021-11-11",
    "2021-11-25",
    "2021-12-24",
    "2021-12-31",
    "2022-01-17",
    "2022-02-21",
    "2022-05-30",
    "2022-07-04",
    "2022-09-05",
    "2022-10-10",
    "2022-11-11",
    "2022-11-24",
    "2022-12-26",
    "2023-01-02",
    "2023-01-16",
    "2023-02-20",
    "2023-05-29",
    "2023-07-04",
    "2023-09-04",
    "2023-10-09",
    "2023-11-10",
    "2023-11-23",
    "2023-12-25",
    "2024-01-01",
    "2024-01-15",
    "2024-02-19",
    "2024-05-27",
    "2024-07-04",
    "2024-09-02",
    "2024-10-14",
    "2024-11-11",
    "2024-11-28",
    "2024-12-25",
    "2025-01-01",
    "2025-01-20",
    "2025-02-17",
    "2025-05-26",
    "2025-07-04",
    "2025-09-01",
    "2025-10-13",
    "2025-11-11",
    "2025-11-27",
    "2025-12-25",
    "2026-01-01",
    "2026-01-19",
    "2026-02-16",
    "2026-05-25",
    "2026-07-03",
    "2026-09-07",
    "2026-10-12",
    "2026-11-11",
    "2026-11-26",
    "2026-12-25",
    "2027-01-01",
    "2027-01-18",
    "2027-02-15",
    "2027-05-31",
    "2027-07-05",
    "2027-09-06",
    "2027-10-11",
    "2027-11-11",
    "2027-11-25",
    "2027-12-24",
    "2027-12-31",
    "2028-01-17",
    "2028-02-21",
    "2028-05-29",
    "2028-07-04",
    "2028-09-04",
    "2028-10-09",
    "2028-11-10",
    "2028-11-23",
    "2028-12-25",
    "2029-01-01",
    "2029-01-15",
    "2029-02-19",
    "2029-05-28",
    "2029-07-04",
    "2029-09-03",
    "2029-10-08",
    "2029-11-12",
    "2029-11-22",
    "2029-12-25",
    "2030-01-01",
    "2030-01-21",
    "2030-02-18",
    "2030-05-27",
    "2030-07-04",
    "2030-09-02",
    "2030-10-14",
    "2030-11-11",
    "2030-11-28",
    "2030-12-25",
]
